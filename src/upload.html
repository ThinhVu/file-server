<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js" integrity="sha512-LUKzDoJKOLqnxGWWIBM4lzRBlxcva2ZTztO8bTcWPmDSpkErWx0bSP4pdsjNH8kiHAUPaT06UXcb+vOEZH+HpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div>
    <button id="uploadBtn">Upload</button>
  </div>
  <script>
    window.addEventListener('load', function (){
      const btn = document.getElementById('uploadBtn')
      btn.addEventListener('click', upload);
    })
    
    function upload() {
      console.log('upload trigger')
      openFileDialog({ multiple: false, mimeType: '*/*' }).then(files => {
        console.log('files', files);
        console.log('upload files 0');
        uploadFile(files[0], {
          uploadCompletedCallback: (responseData) => console.log('upload completed', responseData),
          uploadProgressCallback: (pt) => console.log('upload', pt, '%')
        })
      })
    }
    
    function openFileDialog(options = { multiple: false, mimeType: '*/*' }) {
      return new Promise(resolve => {
        const input = document.createElement('input')
        input.type = 'file'
        input.accept = options.mimeType
        input.multiple = options.multiple
        input.addEventListener('change', e => resolve(e.target.files));
        document.body.appendChild(input)
        input.style.display = 'none'
        input.click()
        input.parentNode.removeChild(input)
      })
    }
    
    async function readFile(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.addEventListener('load', event => resolve(event.target.result));
        reader.readAsText(file, 'utf-8');
      })
    }
    
    const apiUrl = 'http://localhost:8081/api';
    
    function uploadFile(file, { uploadCompletedCallback, uploadProgressCallback }) {
      const formData = new FormData()
      formData.append('file', file)

      const source = axios.CancelToken.source()

      const upload = {
        value: {
          progress: 0,
          inProgress: true,
          cancel: source.cancel,
          mimeType: file.type,
          fileName: file.name,
        }
      }

      function onUploadProgress(progress) {
        const progressPercentage = Math.round(progress.loaded * 100 / progress.total);
        upload.value.progress = progressPercentage;
        uploadProgressCallback && uploadProgressCallback(progressPercentage);
      }

      let responseData
      axios.post(apiUrl, formData, { cancelToken: source.token, onUploadProgress })
      .then(async (response) => {
        upload.value.progress = 100
        upload.value.success = true
        responseData = response
      })
      .catch(() => {
        upload.value.progress = 0
        upload.value.success = false
      })
      .finally(() => {
        upload.value.inProgress = false
        uploadCompletedCallback(responseData)
      })

      return upload
    }

    function resolveFile(file) {
      return `${apiUrl}/${file}`;
    }
  </script>
</body>
</html>
